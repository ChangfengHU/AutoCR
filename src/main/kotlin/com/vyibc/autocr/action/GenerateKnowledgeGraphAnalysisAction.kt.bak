package com.vyibc.autocr.action

import com.intellij.openapi.actionSystem.AnAction
import com.intellij.openapi.actionSystem.AnActionEvent
import com.intellij.openapi.components.service
import com.intellij.openapi.progress.ProgressIndicator
import com.intellij.openapi.progress.ProgressManager
import com.intellij.openapi.progress.Task
import com.intellij.openapi.project.Project
import com.vyibc.autocr.indexing.ProjectIndexingService
import com.vyibc.autocr.export.GraphExportService
import com.vyibc.autocr.settings.AutoCRSettingsState
import com.vyibc.autocr.psi.PSIService
import org.slf4j.LoggerFactory
import java.io.File
import java.time.LocalDateTime
import java.time.format.DateTimeFormatter
import javax.swing.JOptionPane

/**
 * ç”ŸæˆçŸ¥è¯†å›¾è°±åˆ†ææ–‡ä»¶çš„Action
 * ç”¨äºå³é”®èœå•å¿«é€Ÿå¯¼å‡ºé¡¹ç›®çŸ¥è¯†å›¾è°±åˆ†æ
 */
class GenerateKnowledgeGraphAnalysisAction : AnAction(
    "ç”ŸæˆçŸ¥è¯†å›¾è°±åˆ†æ", 
    "ç”Ÿæˆé¡¹ç›®çŸ¥è¯†å›¾è°±åˆ†ææ–‡ä»¶", 
    null
) {
    
    private val logger = LoggerFactory.getLogger(GenerateKnowledgeGraphAnalysisAction::class.java)
    
    override fun actionPerformed(e: AnActionEvent) {
        val project = e.project ?: return
        
        val indexingService = project.service<ProjectIndexingService>()
        val exportService = project.service<GraphExportService>()
        val psiService = project.service<PSIService>()
        
        // æ£€æŸ¥é¡¹ç›®æ˜¯å¦å·²ç´¢å¼•
        val indexingStatus = indexingService.getIndexingStatus()
        
        if (indexingStatus.isIndexing) {
            JOptionPane.showMessageDialog(
                null,
                """
                <html>
                <h3>â³ é¡¹ç›®æ­£åœ¨ç´¢å¼•ä¸­</h3>
                <p>è¯·ç­‰å¾…å½“å‰ç´¢å¼•å®Œæˆåå†ç”ŸæˆçŸ¥è¯†å›¾è°±åˆ†æã€‚</p>
                <br>
                <p><b>ç´¢å¼•è¿›åº¦ï¼š</b></p>
                <p>â€¢ å·²å¤„ç†æ–‡ä»¶: ${indexingStatus.processedFiles}/${indexingStatus.totalFiles}</p>
                <p>â€¢ å‘ç°ç±»: ${indexingStatus.totalClasses}</p>
                <p>â€¢ å‘ç°æ–¹æ³•: ${indexingStatus.totalMethods}</p>
                </html>
                """.trimIndent(),
                "é¡¹ç›®ç´¢å¼•è¿›è¡Œä¸­",
                JOptionPane.INFORMATION_MESSAGE
            )
            return
        }
        
        if (!indexingStatus.isIndexed) {
            val result = JOptionPane.showConfirmDialog(
                null,
                """
                <html>
                <h3>ğŸ“‹ é¡¹ç›®å°šæœªç´¢å¼•</h3>
                <p>éœ€è¦å…ˆè¿›è¡Œé¡¹ç›®ç´¢å¼•æ‰èƒ½ç”ŸæˆçŸ¥è¯†å›¾è°±åˆ†æã€‚</p>
                <br>
                <p><b>ç´¢å¼•è¿‡ç¨‹å°†ï¼š</b></p>
                <ul>
                <li>â€¢ æ‰«ææ‰€æœ‰æºä»£ç æ–‡ä»¶</li>
                <li>â€¢ æ„å»ºç±»å’Œæ–¹æ³•çš„å…³ç³»å›¾è°±</li>
                <li>â€¢ åˆ†æä»£ç ç»“æ„å’Œä¾èµ–å…³ç³»</li>
                <li>â€¢ è®¡ç®—å¤æ‚åº¦å’Œåº¦é‡æŒ‡æ ‡</li>
                </ul>
                <br>
                <p>æ˜¯å¦ç°åœ¨å¼€å§‹ç´¢å¼•ï¼Ÿ</p>
                </html>
                """.trimIndent(),
                "éœ€è¦å…ˆç´¢å¼•é¡¹ç›®",
                JOptionPane.YES_NO_OPTION,
                JOptionPane.QUESTION_MESSAGE
            )
            
            if (result == JOptionPane.YES_OPTION) {
                indexingService.startProjectIndexing(false)
            }
            return
        }
        
        // æ˜¾ç¤ºç”Ÿæˆé€‰é¡¹å¯¹è¯æ¡†
        val options = arrayOf(
            "å®Œæ•´åˆ†æ (JSON + Cypher + æŠ¥å‘Š)",
            "ä»…ç”Ÿæˆåˆ†ææŠ¥å‘Š",
            "ä»…å¯¼å‡ºJSONæ•°æ®",
            "ä»…å¯¼å‡ºCypherè„šæœ¬"
        )
        
        val choice = JOptionPane.showOptionDialog(
            null,
            """
            <html>
            <h3>ğŸ“Š ç”ŸæˆçŸ¥è¯†å›¾è°±åˆ†æ</h3>
            <p>è¯·é€‰æ‹©è¦ç”Ÿæˆçš„åˆ†ææ–‡ä»¶ç±»å‹ï¼š</p>
            <br>
            <p><b>å½“å‰é¡¹ç›®ç»Ÿè®¡ï¼š</b></p>
            <p>â€¢ ç±»æ•°é‡: ${indexingStatus.totalClasses}</p>
            <p>â€¢ æ–¹æ³•æ•°é‡: ${indexingStatus.totalMethods}</p>
            <p>â€¢ å…³ç³»æ•°é‡: ${indexingStatus.totalEdges}</p>
            <p>â€¢ å·²ç´¢å¼•æ–‡ä»¶: ${indexingStatus.processedFiles}</p>
            <br>
            <p>é€‰æ‹©ç”Ÿæˆç±»å‹ï¼š</p>
            </html>
            """.trimIndent(),
            "é€‰æ‹©åˆ†æç±»å‹",
            JOptionPane.DEFAULT_OPTION,
            JOptionPane.QUESTION_MESSAGE,
            null,
            options,
            options[0]
        )
        
        if (choice == -1) return // ç”¨æˆ·å–æ¶ˆ
        
        // ä½¿ç”¨è¿›åº¦æ¡æ˜¾ç¤ºç”Ÿæˆè¿‡ç¨‹
        ProgressManager.getInstance().run(object : Task.Backgroundable(project, "æ­£åœ¨ç”ŸæˆçŸ¥è¯†å›¾è°±åˆ†æ...", true) {
            override fun run(indicator: ProgressIndicator) {
                try {
                    indicator.text = "æ­£åœ¨å‡†å¤‡å¯¼å‡ºæ•°æ®..."
                    indicator.fraction = 0.0
                    
                    // è·å–ä»£ç å›¾è°±
                    val codeGraph = psiService.getCodeGraph()
                    
                    // åˆ›å»ºè¾“å‡ºç›®å½•
                    val outputDir = File(project.basePath, "autocr-exports")
                    if (!outputDir.exists()) {
                        outputDir.mkdirs()
                    }
                    
                    val timestamp = LocalDateTime.now().format(DateTimeFormatter.ofPattern("yyyyMMdd-HHmmss"))
                    val baseName = "${project.name}-knowledge-graph-$timestamp"
                    
                    val results = mutableListOf<Pair<String, Boolean>>()
                    
                    when (choice) {
                        0 -> { // å®Œæ•´åˆ†æ
                            indicator.text = "æ­£åœ¨å¯¼å‡ºJSONæ•°æ®..."
                            indicator.fraction = 0.2
                            val jsonPath = File(outputDir, "$baseName.json").absolutePath
                            val jsonResult = exportService.exportToJson(codeGraph, jsonPath)
                            results.add("JSONæ•°æ®" to jsonResult.success)
                            
                            indicator.text = "æ­£åœ¨å¯¼å‡ºCypherè„šæœ¬..."
                            indicator.fraction = 0.5
                            val cypherPath = File(outputDir, "$baseName.cypher").absolutePath
                            val cypherResult = exportService.exportToCypher(codeGraph, cypherPath)
                            results.add("Cypherè„šæœ¬" to cypherResult.success)
                            
                            indicator.text = "æ­£åœ¨ç”Ÿæˆåˆ†ææŠ¥å‘Š..."
                            indicator.fraction = 0.8
                            val reportPath = File(outputDir, "$baseName-analysis.md").absolutePath
                            val reportResult = exportService.generateSummaryReport(codeGraph, reportPath)
                            results.add("åˆ†ææŠ¥å‘Š" to reportResult.success)
                        }
                        1 -> { // ä»…åˆ†ææŠ¥å‘Š
                            indicator.text = "æ­£åœ¨ç”Ÿæˆåˆ†ææŠ¥å‘Š..."
                            indicator.fraction = 0.5
                            val reportPath = File(outputDir, "$baseName-analysis.md").absolutePath
                            val reportResult = exportService.generateSummaryReport(codeGraph, reportPath)
                            results.add("åˆ†ææŠ¥å‘Š" to reportResult.success)
                        }
                        2 -> { // ä»…JSON
                            indicator.text = "æ­£åœ¨å¯¼å‡ºJSONæ•°æ®..."
                            indicator.fraction = 0.5
                            val jsonPath = File(outputDir, "$baseName.json").absolutePath
                            val jsonResult = exportService.exportToJson(codeGraph, jsonPath)
                            results.add("JSONæ•°æ®" to jsonResult.success)
                        }
                        3 -> { // ä»…Cypher
                            indicator.text = "æ­£åœ¨å¯¼å‡ºCypherè„šæœ¬..."
                            indicator.fraction = 0.5
                            val cypherPath = File(outputDir, "$baseName.cypher").absolutePath
                            val cypherResult = exportService.exportToCypher(codeGraph, cypherPath)
                            results.add("Cypherè„šæœ¬" to cypherResult.success)
                        }
                    }
                    
                    indicator.text = "ç”Ÿæˆå®Œæˆï¼Œæ­£åœ¨æ•´ç†æ–‡ä»¶..."
                    indicator.fraction = 0.95
                    
                    // ç­‰å¾…ä¸€ç§’è®©ç”¨æˆ·çœ‹åˆ°å®ŒæˆçŠ¶æ€
                    Thread.sleep(1000)
                    indicator.fraction = 1.0
                    
                    // æ˜¾ç¤ºç»“æœ
                    javax.swing.SwingUtilities.invokeLater {
                        val successCount = results.count { it.second }
                        val totalCount = results.size
                        
                        if (successCount > 0) {
                            val resultText = results.map { (name, success) ->
                                if (success) "âœ… $name" else "âŒ $name"
                            }.joinToString("\n")
                            
                            val message = """
                            <html>
                            <h3>ğŸ‰ çŸ¥è¯†å›¾è°±åˆ†æå·²ç”Ÿæˆï¼</h3>
                            <p><b>ç”Ÿæˆç»“æœ ($successCount/$totalCount)ï¼š</b></p>
                            <p style='font-family: monospace;'>
                            $resultText
                            </p>
                            <br>
                            <p><b>ğŸ“ è¾“å‡ºç›®å½•ï¼š</b></p>
                            <p style='font-family: monospace; color: #0066cc;'>${outputDir.absolutePath}</p>
                            <br>
                            <p><b>ğŸ“Š ç»Ÿè®¡ä¿¡æ¯ï¼š</b></p>
                            <table>
                            <tr><td>â€¢ ç±»èŠ‚ç‚¹ï¼š</td><td><b>${indexingStatus.totalClasses}</b></td></tr>
                            <tr><td>â€¢ æ–¹æ³•èŠ‚ç‚¹ï¼š</td><td><b>${indexingStatus.totalMethods}</b></td></tr>
                            <tr><td>â€¢ å…³ç³»è¾¹ï¼š</td><td><b>${indexingStatus.totalEdges}</b></td></tr>
                            </table>
                            <br>
                            <p><i>ğŸ’¡ æ‚¨å¯ä»¥ä½¿ç”¨è¿™äº›æ–‡ä»¶è¿›è¡Œä»£ç åˆ†æã€æ¶æ„å®¡æŸ¥æˆ–å¯¼å…¥åˆ°å›¾æ•°æ®åº“ä¸­ã€‚</i></p>
                            </html>
                            """.trimIndent()
                            
                            JOptionPane.showMessageDialog(
                                null,
                                message,
                                "çŸ¥è¯†å›¾è°±åˆ†æç”ŸæˆæˆåŠŸ",
                                JOptionPane.INFORMATION_MESSAGE
                            )
                        } else {
                            JOptionPane.showMessageDialog(
                                null,
                                """
                                <html>
                                <h3>âŒ ç”Ÿæˆå¤±è´¥</h3>
                                <p>æ‰€æœ‰åˆ†ææ–‡ä»¶ç”Ÿæˆéƒ½å¤±è´¥äº†ã€‚</p>
                                <p>è¯·æ£€æŸ¥æ—¥å¿—æ–‡ä»¶è·å–è¯¦ç»†é”™è¯¯ä¿¡æ¯ã€‚</p>
                                </html>
                                """.trimIndent(),
                                "ç”Ÿæˆå¤±è´¥",
                                JOptionPane.ERROR_MESSAGE
                            )
                        }
                    }
                    
                } catch (e: Exception) {
                    logger.error("Failed to generate knowledge graph analysis", e)
                    
                    javax.swing.SwingUtilities.invokeLater {
                        JOptionPane.showMessageDialog(
                            null,
                            """
                            <html>
                            <h3>ğŸ’¥ ç”Ÿæˆè¿‡ç¨‹ä¸­å‘ç”Ÿé”™è¯¯</h3>
                            <p><b>é”™è¯¯è¯¦æƒ…ï¼š</b></p>
                            <p style='color: red;'>${e.message}</p>
                            <br>
                            <p>è¯·æ£€æŸ¥æ—¥å¿—æ–‡ä»¶è·å–æ›´å¤šä¿¡æ¯ã€‚</p>
                            </html>
                            """.trimIndent(),
                            "ç”Ÿæˆé”™è¯¯",
                            JOptionPane.ERROR_MESSAGE
                        )
                    }
                }
            }
        })
    }
    
    override fun update(e: AnActionEvent) {
        val project = e.project
        e.presentation.isEnabledAndVisible = project != null
        
        if (project != null) {
            val indexingService = project.service<ProjectIndexingService>()
            val indexingStatus = indexingService.getIndexingStatus()
            
            // æ ¹æ®ç´¢å¼•çŠ¶æ€æ›´æ–°æŒ‰é’®æ˜¾ç¤º
            when {
                indexingStatus.isIndexing -> {
                    e.presentation.text = "ç´¢å¼•è¿›è¡Œä¸­..."
                    e.presentation.description = "ç­‰å¾…é¡¹ç›®ç´¢å¼•å®Œæˆåå¯ç”ŸæˆçŸ¥è¯†å›¾è°±åˆ†æ"
                    e.presentation.isEnabled = true // ä»ç„¶å¯ä»¥ç‚¹å‡»æŸ¥çœ‹çŠ¶æ€
                }
                !indexingStatus.isIndexed -> {
                    e.presentation.text = "ç”ŸæˆçŸ¥è¯†å›¾è°±åˆ†æ"
                    e.presentation.description = "éœ€è¦å…ˆç´¢å¼•é¡¹ç›®ï¼Œç„¶åç”ŸæˆçŸ¥è¯†å›¾è°±åˆ†ææ–‡ä»¶"
                    e.presentation.isEnabled = true
                }
                else -> {
                    e.presentation.text = "ç”ŸæˆçŸ¥è¯†å›¾è°±åˆ†æ"
                    e.presentation.description = "å¯¼å‡ºé¡¹ç›®çŸ¥è¯†å›¾è°±ä¸ºJSONã€Cypherè„šæœ¬å’Œåˆ†ææŠ¥å‘Š"
                    e.presentation.isEnabled = true
                }
            }
        }
    }
}