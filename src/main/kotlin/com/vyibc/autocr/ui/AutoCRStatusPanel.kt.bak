package com.vyibc.autocr.ui

import com.intellij.openapi.components.service
import com.intellij.openapi.project.Project
import com.intellij.openapi.wm.ToolWindow
import com.intellij.openapi.wm.ToolWindowFactory
import com.intellij.ui.components.*
import com.intellij.ui.content.ContentFactory
import com.vyibc.autocr.indexing.ProjectIndexingService
import com.vyibc.autocr.neo4j.Neo4jService
import com.vyibc.autocr.settings.AutoCRSettingsState
import org.slf4j.LoggerFactory
import java.awt.*
import java.awt.event.ActionEvent
import java.awt.event.ActionListener
import java.text.SimpleDateFormat
import java.util.*
import javax.swing.*

/**
 * AutoCRçŠ¶æ€é¢æ¿å·¥å‚
 */
class AutoCRStatusToolWindowFactory : ToolWindowFactory {
    override fun createToolWindowContent(project: Project, toolWindow: ToolWindow) {
        val statusPanel = AutoCRStatusPanel(project)
        val content = statusPanel.createContent()
        
        val contentFactory = ContentFactory.getInstance()
        val toolWindowContent = contentFactory.createContent(content, "çŠ¶æ€ç›‘æ§", false)
        
        toolWindow.contentManager.addContent(toolWindowContent)
    }
}

/**
 * AutoCRçŠ¶æ€ç›‘æ§é¢æ¿
 */
class AutoCRStatusPanel(private val project: Project) {
    private val logger = LoggerFactory.getLogger(AutoCRStatusPanel::class.java)
    
    // æœåŠ¡å¼•ç”¨
    private val indexingService = project.service<ProjectIndexingService>()
    private val neo4jService = project.service<Neo4jService>()
    private val settings = AutoCRSettingsState.getInstance(project)
    
    // UIç»„ä»¶
    private lateinit var mainPanel: JPanel
    private lateinit var indexingStatusPanel: JPanel
    private lateinit var neo4jStatusPanel: JPanel
    private lateinit var configStatusPanel: JPanel
    
    // ç´¢å¼•çŠ¶æ€ç»„ä»¶
    private lateinit var indexingStatusLabel: JBLabel
    private lateinit var indexingProgressBar: JProgressBar
    private lateinit var indexingStatsLabel: JBLabel
    private lateinit var lastIndexTimeLabel: JBLabel
    private lateinit var forceReindexButton: JButton
    
    // Neo4jçŠ¶æ€ç»„ä»¶
    private lateinit var neo4jStatusLabel: JBLabel
    private lateinit var neo4jStatsLabel: JBLabel
    private lateinit var testNeo4jButton: JButton
    private lateinit var syncToNeo4jButton: JButton
    
    // é…ç½®çŠ¶æ€ç»„ä»¶
    private lateinit var configStatusLabel: JBLabel
    private lateinit var enabledProvidersLabel: JBLabel
    private lateinit var openSettingsButton: JButton
    
    // å®šæ—¶åˆ·æ–°
    private val refreshTimer = javax.swing.Timer(5000) { refreshStatus() }
    
    init {
        refreshTimer.start()
    }
    
    fun createContent(): JComponent {
        mainPanel = JPanel(BorderLayout())
        
        val tabbedPane = JBTabbedPane()
        
        // æ¦‚è§ˆæ ‡ç­¾é¡µ
        val overviewPanel = createOverviewPanel()
        tabbedPane.addTab("æ¦‚è§ˆ", overviewPanel)
        
        // ç´¢å¼•çŠ¶æ€æ ‡ç­¾é¡µ
        indexingStatusPanel = createIndexingStatusPanel()
        tabbedPane.addTab("é¡¹ç›®ç´¢å¼•", indexingStatusPanel)
        
        // Neo4jçŠ¶æ€æ ‡ç­¾é¡µ
        neo4jStatusPanel = createNeo4jStatusPanel()
        tabbedPane.addTab("Neo4j", neo4jStatusPanel)
        
        // é…ç½®çŠ¶æ€æ ‡ç­¾é¡µ
        configStatusPanel = createConfigStatusPanel()
        tabbedPane.addTab("é…ç½®", configStatusPanel)
        
        mainPanel.add(tabbedPane, BorderLayout.CENTER)
        
        // åˆå§‹åŒ–çŠ¶æ€
        refreshStatus()
        
        return mainPanel
    }
    
    /**
     * åˆ›å»ºæ¦‚è§ˆé¢æ¿
     */
    private fun createOverviewPanel(): JPanel {
        val panel = JPanel(BorderLayout())
        val contentPanel = JPanel()
        contentPanel.layout = BoxLayout(contentPanel, BoxLayout.Y_AXIS)
        contentPanel.border = BorderFactory.createEmptyBorder(10, 10, 10, 10)
        
        // æ ‡é¢˜
        val titleLabel = JBLabel("<html><h2>AutoCR çŠ¶æ€æ¦‚è§ˆ</h2></html>")
        contentPanel.add(titleLabel)
        contentPanel.add(Box.createVerticalStrut(15))
        
        // å¿«é€ŸçŠ¶æ€å¡ç‰‡
        val quickStatusPanel = createQuickStatusCards()
        contentPanel.add(quickStatusPanel)
        contentPanel.add(Box.createVerticalStrut(15))
        
        // æ“ä½œæŒ‰é’®
        val actionPanel = createQuickActionsPanel()
        contentPanel.add(actionPanel)
        
        contentPanel.add(Box.createVerticalGlue())
        
        panel.add(contentPanel, BorderLayout.CENTER)
        return panel
    }
    
    /**
     * åˆ›å»ºå¿«é€ŸçŠ¶æ€å¡ç‰‡
     */
    private fun createQuickStatusCards(): JPanel {
        val panel = JPanel(GridLayout(2, 2, 10, 10))
        
        // ç´¢å¼•çŠ¶æ€å¡ç‰‡
        val indexCard = createStatusCard("é¡¹ç›®ç´¢å¼•", "æ£€æŸ¥ä¸­...", Color.ORANGE)
        panel.add(indexCard)
        
        // Neo4jçŠ¶æ€å¡ç‰‡
        val neo4jCard = createStatusCard("Neo4jæ•°æ®åº“", "æ£€æŸ¥ä¸­...", Color.ORANGE)
        panel.add(neo4jCard)
        
        // AIé…ç½®å¡ç‰‡
        val aiCard = createStatusCard("AIä¾›åº”å•†", "æ£€æŸ¥ä¸­...", Color.ORANGE)
        panel.add(aiCard)
        
        // æ€»ä½“çŠ¶æ€å¡ç‰‡
        val overallCard = createStatusCard("æ€»ä½“çŠ¶æ€", "æ£€æŸ¥ä¸­...", Color.ORANGE)
        panel.add(overallCard)
        
        return panel
    }
    
    /**
     * åˆ›å»ºçŠ¶æ€å¡ç‰‡
     */
    private fun createStatusCard(title: String, status: String, color: Color): JPanel {
        val card = JPanel(BorderLayout())
        card.border = BorderFactory.createCompoundBorder(
            BorderFactory.createLineBorder(color, 2),
            BorderFactory.createEmptyBorder(10, 10, 10, 10)
        )
        card.background = Color.WHITE
        
        val titleLabel = JBLabel("<html><b>$title</b></html>")
        val statusLabel = JBLabel(status)
        statusLabel.foreground = color
        
        card.add(titleLabel, BorderLayout.NORTH)
        card.add(statusLabel, BorderLayout.CENTER)
        
        return card
    }
    
    /**
     * åˆ›å»ºå¿«é€Ÿæ“ä½œé¢æ¿
     */
    private fun createQuickActionsPanel(): JPanel {
        val panel = JPanel()
        panel.layout = BoxLayout(panel, BoxLayout.Y_AXIS)
        panel.border = BorderFactory.createTitledBorder("å¿«é€Ÿæ“ä½œ")
        
        val buttonPanel = JPanel()
        buttonPanel.layout = BoxLayout(buttonPanel, BoxLayout.X_AXIS)
        
        val startIndexButton = JButton("å¼€å§‹é¡¹ç›®ç´¢å¼•").apply {
            addActionListener { indexingService.startProjectIndexing() }
        }
        
        val openSettingsBtn = JButton("æ‰“å¼€è®¾ç½®").apply {
            addActionListener { openSettings() }
        }
        
        val refreshStatusBtn = JButton("åˆ·æ–°çŠ¶æ€").apply {
            addActionListener { refreshStatus() }
        }
        
        val syncToNeo4jBtn = JButton("ğŸ”„ åŒæ­¥åˆ°Neo4j").apply {
            addActionListener { syncKnowledgeGraphToNeo4j() }
            toolTipText = "æ‰‹åŠ¨å°†é¡¹ç›®çŸ¥è¯†å›¾è°±åŒæ­¥åˆ°Neo4jæ•°æ®åº“ (Ctrl+Alt+N)"
            background = java.awt.Color(34, 139, 34)  // æ£®æ—ç»¿
            foreground = java.awt.Color.WHITE
            isOpaque = true
            font = font.deriveFont(java.awt.Font.BOLD)
            preferredSize = java.awt.Dimension(140, 30)
        }
        
        buttonPanel.add(startIndexButton)
        buttonPanel.add(Box.createHorizontalStrut(10))
        buttonPanel.add(syncToNeo4jBtn)
        buttonPanel.add(Box.createHorizontalStrut(10))
        buttonPanel.add(openSettingsBtn)
        buttonPanel.add(Box.createHorizontalStrut(10))
        buttonPanel.add(refreshStatusBtn)
        buttonPanel.add(Box.createHorizontalGlue())
        
        panel.add(buttonPanel)
        
        return panel
    }
    
    /**
     * åˆ›å»ºç´¢å¼•çŠ¶æ€é¢æ¿
     */
    private fun createIndexingStatusPanel(): JPanel {
        val panel = JPanel(BorderLayout())
        val contentPanel = JPanel()
        contentPanel.layout = BoxLayout(contentPanel, BoxLayout.Y_AXIS)
        contentPanel.border = BorderFactory.createEmptyBorder(10, 10, 10, 10)
        
        // çŠ¶æ€ä¿¡æ¯
        val statusInfoPanel = JPanel()
        statusInfoPanel.border = BorderFactory.createTitledBorder("ç´¢å¼•çŠ¶æ€")
        statusInfoPanel.layout = BoxLayout(statusInfoPanel, BoxLayout.Y_AXIS)
        
        indexingStatusLabel = JBLabel("çŠ¶æ€: æ£€æŸ¥ä¸­...")
        indexingProgressBar = JProgressBar(0, 100)
        indexingProgressBar.isStringPainted = true
        indexingStatsLabel = JBLabel("ç»Ÿè®¡: åŠ è½½ä¸­...")
        lastIndexTimeLabel = JBLabel("ä¸Šæ¬¡ç´¢å¼•: ä»æœª")
        
        statusInfoPanel.add(indexingStatusLabel)
        statusInfoPanel.add(Box.createVerticalStrut(5))
        statusInfoPanel.add(indexingProgressBar)
        statusInfoPanel.add(Box.createVerticalStrut(5))
        statusInfoPanel.add(indexingStatsLabel)
        statusInfoPanel.add(Box.createVerticalStrut(5))
        statusInfoPanel.add(lastIndexTimeLabel)
        
        // æ“ä½œæŒ‰é’®
        val buttonPanel = JPanel()
        buttonPanel.layout = BoxLayout(buttonPanel, BoxLayout.X_AXIS)
        
        forceReindexButton = JButton("å¼ºåˆ¶é‡æ–°ç´¢å¼•").apply {
            addActionListener { 
                val result = JOptionPane.showConfirmDialog(
                    this@AutoCRStatusPanel.mainPanel,
                    "ç¡®å®šè¦å¼ºåˆ¶é‡æ–°ç´¢å¼•æ•´ä¸ªé¡¹ç›®å—ï¼Ÿè¿™å¯èƒ½éœ€è¦ä¸€äº›æ—¶é—´ã€‚",
                    "ç¡®è®¤é‡æ–°ç´¢å¼•",
                    JOptionPane.YES_NO_OPTION
                )
                if (result == JOptionPane.YES_OPTION) {
                    indexingService.forceReindex()
                }
            }
        }
        
        val viewStatsButton = JButton("æŸ¥çœ‹è¯¦ç»†ç»Ÿè®¡").apply {
            addActionListener { showIndexingStats() }
        }
        
        buttonPanel.add(forceReindexButton)
        buttonPanel.add(Box.createHorizontalStrut(10))
        buttonPanel.add(viewStatsButton)
        buttonPanel.add(Box.createHorizontalGlue())
        
        contentPanel.add(statusInfoPanel)
        contentPanel.add(Box.createVerticalStrut(15))
        contentPanel.add(buttonPanel)
        contentPanel.add(Box.createVerticalGlue())
        
        panel.add(contentPanel, BorderLayout.CENTER)
        return panel
    }
    
    /**
     * åˆ›å»ºNeo4jçŠ¶æ€é¢æ¿
     */
    private fun createNeo4jStatusPanel(): JPanel {
        val panel = JPanel(BorderLayout())
        val contentPanel = JPanel()
        contentPanel.layout = BoxLayout(contentPanel, BoxLayout.Y_AXIS)
        contentPanel.border = BorderFactory.createEmptyBorder(10, 10, 10, 10)
        
        // è¿æ¥çŠ¶æ€
        val connectionPanel = JPanel()
        connectionPanel.border = BorderFactory.createTitledBorder("è¿æ¥çŠ¶æ€")
        connectionPanel.layout = BoxLayout(connectionPanel, BoxLayout.Y_AXIS)
        
        neo4jStatusLabel = JBLabel("çŠ¶æ€: æ£€æŸ¥ä¸­...")
        neo4jStatsLabel = JBLabel("æ•°æ®åº“ç»Ÿè®¡: åŠ è½½ä¸­...")
        
        connectionPanel.add(neo4jStatusLabel)
        connectionPanel.add(Box.createVerticalStrut(5))
        connectionPanel.add(neo4jStatsLabel)
        
        // æ“ä½œæŒ‰é’®
        val buttonPanel = JPanel()
        buttonPanel.layout = BoxLayout(buttonPanel, BoxLayout.X_AXIS)
        
        testNeo4jButton = JButton("æµ‹è¯•è¿æ¥").apply {
            addActionListener { testNeo4jConnection() }
        }
        
        syncToNeo4jButton = JButton("ğŸš€ ç«‹å³åŒæ­¥").apply {
            addActionListener { syncKnowledgeGraphToNeo4j() }
            toolTipText = "å°†é¡¹ç›®çŸ¥è¯†å›¾è°±åŒæ­¥åˆ°Neo4jæ•°æ®åº“"
            background = java.awt.Color(255, 140, 0)  // æ©™è‰²
            foreground = java.awt.Color.WHITE
            isOpaque = true
            font = font.deriveFont(java.awt.Font.BOLD)
        }
        
        val configNeo4jButton = JButton("é…ç½®Neo4j").apply {
            addActionListener { openSettings() }
        }
        
        buttonPanel.add(testNeo4jButton)
        buttonPanel.add(Box.createHorizontalStrut(10))
        buttonPanel.add(syncToNeo4jButton)
        buttonPanel.add(Box.createHorizontalStrut(10))
        buttonPanel.add(configNeo4jButton)
        buttonPanel.add(Box.createHorizontalGlue())
        
        contentPanel.add(connectionPanel)
        contentPanel.add(Box.createVerticalStrut(15))
        contentPanel.add(buttonPanel)
        contentPanel.add(Box.createVerticalGlue())
        
        panel.add(contentPanel, BorderLayout.CENTER)
        return panel
    }
    
    /**
     * åˆ›å»ºé…ç½®çŠ¶æ€é¢æ¿
     */
    private fun createConfigStatusPanel(): JPanel {
        val panel = JPanel(BorderLayout())
        val contentPanel = JPanel()
        contentPanel.layout = BoxLayout(contentPanel, BoxLayout.Y_AXIS)
        contentPanel.border = BorderFactory.createEmptyBorder(10, 10, 10, 10)
        
        // é…ç½®çŠ¶æ€
        val configInfoPanel = JPanel()
        configInfoPanel.border = BorderFactory.createTitledBorder("é…ç½®çŠ¶æ€")
        configInfoPanel.layout = BoxLayout(configInfoPanel, BoxLayout.Y_AXIS)
        
        configStatusLabel = JBLabel("é…ç½®çŠ¶æ€: æ£€æŸ¥ä¸­...")
        enabledProvidersLabel = JBLabel("å·²å¯ç”¨çš„AIä¾›åº”å•†: æ£€æŸ¥ä¸­...")
        
        configInfoPanel.add(configStatusLabel)
        configInfoPanel.add(Box.createVerticalStrut(5))
        configInfoPanel.add(enabledProvidersLabel)
        
        // é…ç½®æŒ‰é’®
        val buttonPanel = JPanel()
        buttonPanel.layout = BoxLayout(buttonPanel, BoxLayout.X_AXIS)
        
        openSettingsButton = JButton("æ‰“å¼€è®¾ç½®").apply {
            addActionListener { openSettings() }
        }
        
        val validateConfigButton = JButton("éªŒè¯é…ç½®").apply {
            addActionListener { validateConfiguration() }
        }
        
        buttonPanel.add(openSettingsButton)
        buttonPanel.add(Box.createHorizontalStrut(10))
        buttonPanel.add(validateConfigButton)
        buttonPanel.add(Box.createHorizontalGlue())
        
        contentPanel.add(configInfoPanel)
        contentPanel.add(Box.createVerticalStrut(15))
        contentPanel.add(buttonPanel)
        contentPanel.add(Box.createVerticalGlue())
        
        panel.add(contentPanel, BorderLayout.CENTER)
        return panel
    }
    
    /**
     * åˆ·æ–°çŠ¶æ€
     */
    private fun refreshStatus() {
        SwingUtilities.invokeLater {
            updateIndexingStatus()
            updateNeo4jStatus()
            updateConfigStatus()
        }
    }
    
    /**
     * æ›´æ–°ç´¢å¼•çŠ¶æ€
     */
    private fun updateIndexingStatus() {
        val status = indexingService.getIndexingStatus()
        
        val statusText = when {
            status.isIndexing -> "æ­£åœ¨ç´¢å¼•ä¸­..."
            status.isIndexed -> "å·²å®Œæˆç´¢å¼•"
            else -> "æœªç´¢å¼•"
        }
        
        indexingStatusLabel.text = "çŠ¶æ€: $statusText"
        
        if (status.isIndexing) {
            val progress = if (status.totalFiles > 0) {
                (status.processedFiles * 100) / status.totalFiles
            } else 0
            indexingProgressBar.value = progress
            indexingProgressBar.string = "${status.processedFiles}/${status.totalFiles} æ–‡ä»¶"
        } else {
            indexingProgressBar.value = if (status.isIndexed) 100 else 0
            indexingProgressBar.string = if (status.isIndexed) "å®Œæˆ" else "æœªå¼€å§‹"
        }
        
        indexingStatsLabel.text = "ç»Ÿè®¡: ${status.totalClasses} ä¸ªç±», ${status.totalMethods} ä¸ªæ–¹æ³•, ${status.totalEdges} ä¸ªå…³ç³»"
        
        if (status.lastIndexTime > 0) {
            val dateFormat = SimpleDateFormat("yyyy-MM-dd HH:mm:ss")
            lastIndexTimeLabel.text = "ä¸Šæ¬¡ç´¢å¼•: ${dateFormat.format(Date(status.lastIndexTime))}"
        } else {
            lastIndexTimeLabel.text = "ä¸Šæ¬¡ç´¢å¼•: ä»æœª"
        }
        
        forceReindexButton.isEnabled = !status.isIndexing
    }
    
    /**
     * æ›´æ–°Neo4jçŠ¶æ€
     */
    private fun updateNeo4jStatus() {
        if (!settings.neo4jConfig.enabled) {
            neo4jStatusLabel.text = "çŠ¶æ€: æœªå¯ç”¨"
            neo4jStatsLabel.text = "Neo4jæœªåœ¨é…ç½®ä¸­å¯ç”¨"
            syncToNeo4jButton.isEnabled = false
            return
        }
        
        val testResult = neo4jService.testConnection()
        
        neo4jStatusLabel.text = if (testResult.success) {
            "çŠ¶æ€: å·²è¿æ¥ (${testResult.responseTime}ms)"
        } else {
            "çŠ¶æ€: è¿æ¥å¤±è´¥ - ${testResult.message}"
        }
        
        val stats = neo4jService.getDatabaseStats()
        neo4jStatsLabel.text = if (stats != null) {
            "æ•°æ®åº“: ${stats.totalNodes} ä¸ªèŠ‚ç‚¹, ${stats.totalRelationships} ä¸ªå…³ç³», ${stats.databaseSize}"
        } else {
            "æ•°æ®åº“ç»Ÿè®¡: æ— æ³•è·å–"
        }
        
        syncToNeo4jButton.isEnabled = testResult.success && !indexingService.getIndexingStatus().isIndexing
    }
    
    /**
     * æ›´æ–°é…ç½®çŠ¶æ€
     */
    private fun updateConfigStatus() {
        val enabledProviders = mutableListOf<String>()
        
        if (settings.openAIConfig.enabled) enabledProviders.add("OpenAI")
        if (settings.anthropicConfig.enabled) enabledProviders.add("Anthropic")
        if (settings.googleConfig.enabled) enabledProviders.add("Google")
        if (settings.ollamaConfig.enabled) enabledProviders.add("Ollama")
        if (settings.azureOpenAIConfig.enabled) enabledProviders.add("Azure OpenAI")
        
        val configValid = enabledProviders.isNotEmpty()
        
        configStatusLabel.text = if (configValid) {
            "é…ç½®çŠ¶æ€: é…ç½®æœ‰æ•ˆ"
        } else {
            "é…ç½®çŠ¶æ€: éœ€è¦é…ç½®AIä¾›åº”å•†"
        }
        
        enabledProvidersLabel.text = if (enabledProviders.isNotEmpty()) {
            "å·²å¯ç”¨çš„AIä¾›åº”å•†: ${enabledProviders.joinToString(", ")}"
        } else {
            "å·²å¯ç”¨çš„AIä¾›åº”å•†: æ— "
        }
    }
    
    /**
     * æµ‹è¯•Neo4jè¿æ¥
     */
    private fun testNeo4jConnection() {
        testNeo4jButton.text = "æµ‹è¯•ä¸­..."
        testNeo4jButton.isEnabled = false
        
        Thread {
            val result = neo4jService.testConnection()
            
            SwingUtilities.invokeLater {
                testNeo4jButton.text = "æµ‹è¯•è¿æ¥"
                testNeo4jButton.isEnabled = true
                
                val messageType = if (result.success) {
                    JOptionPane.INFORMATION_MESSAGE
                } else {
                    JOptionPane.ERROR_MESSAGE
                }
                
                JOptionPane.showMessageDialog(
                    mainPanel,
                    "è¿æ¥æµ‹è¯•ç»“æœ: ${result.message}\\nå“åº”æ—¶é—´: ${result.responseTime}ms",
                    "Neo4jè¿æ¥æµ‹è¯•",
                    messageType
                )
            }
        }.start()
    }
    
    /**
     * åŒæ­¥åˆ°Neo4j
     */
    private fun syncToNeo4j() {
        syncToNeo4jButton.text = "åŒæ­¥ä¸­..."
        syncToNeo4jButton.isEnabled = false
        
        Thread {
            val psiService = com.vyibc.autocr.psi.PSIService.getInstance(project)
            val codeGraph = psiService.getCodeGraph()
            val result = neo4jService.syncCodeGraphToNeo4j(codeGraph)
            
            SwingUtilities.invokeLater {
                syncToNeo4jButton.text = "åŒæ­¥æ•°æ®"
                syncToNeo4jButton.isEnabled = true
                
                val messageType = if (result.success) {
                    JOptionPane.INFORMATION_MESSAGE
                } else {
                    JOptionPane.ERROR_MESSAGE
                }
                
                JOptionPane.showMessageDialog(
                    mainPanel,
                    "åŒæ­¥ç»“æœ: ${result.message}\\n" +
                    "åŒæ­¥èŠ‚ç‚¹: ${result.syncedNodes}\\n" +
                    "åŒæ­¥å…³ç³»: ${result.syncedEdges}\\n" +
                    "è€—æ—¶: ${result.duration}ms",
                    "Neo4jåŒæ­¥ç»“æœ",
                    messageType
                )
                
                // åˆ·æ–°çŠ¶æ€
                updateNeo4jStatus()
            }
        }.start()
    }
    
    /**
     * æ˜¾ç¤ºç´¢å¼•ç»Ÿè®¡è¯¦æƒ…
     */
    private fun showIndexingStats() {
        val summary = indexingService.getIndexingSummary()
        
        val message = if (summary != null) {
            """
            é¡¹ç›®: ${summary.projectName}
            
            æ–‡ä»¶ç»Ÿè®¡:
            - æ€»æ–‡ä»¶æ•°: ${summary.totalFiles}
            - å·²å¤„ç†: ${summary.processedFiles}
            
            ä»£ç ç»Ÿè®¡:
            - ç±»: ${summary.totalClasses}
            - æ–¹æ³•: ${summary.totalMethods}
            - å…³ç³»: ${summary.totalEdges}
            
            æ€§èƒ½:
            - ç´¢å¼•è€—æ—¶: ${summary.indexingTime / 1000.0} ç§’
            - ç´¢å¼•æ—¶é—´: ${SimpleDateFormat("yyyy-MM-dd HH:mm:ss").format(Date(summary.timestamp))}
            """.trimIndent()
        } else {
            "æš‚æ— ç´¢å¼•ç»Ÿè®¡ä¿¡æ¯"
        }
        
        JOptionPane.showMessageDialog(
            mainPanel,
            message,
            "ç´¢å¼•ç»Ÿè®¡è¯¦æƒ…",
            JOptionPane.INFORMATION_MESSAGE
        )
    }
    
    /**
     * éªŒè¯é…ç½®
     */
    private fun validateConfiguration() {
        val errors = mutableListOf<String>()
        
        // æ£€æŸ¥AIä¾›åº”å•†é…ç½®
        val enabledCount = listOf(
            settings.openAIConfig.enabled,
            settings.anthropicConfig.enabled,
            settings.googleConfig.enabled,
            settings.ollamaConfig.enabled,
            settings.azureOpenAIConfig.enabled
        ).count { it }
        
        if (enabledCount == 0) {
            errors.add("è‡³å°‘éœ€è¦å¯ç”¨ä¸€ä¸ªAIä¾›åº”å•†")
        }
        
        // æ£€æŸ¥API Key
        if (settings.openAIConfig.enabled && settings.openAIConfig.apiKey.isBlank()) {
            errors.add("OpenAI API Keyæœªé…ç½®")
        }
        if (settings.anthropicConfig.enabled && settings.anthropicConfig.apiKey.isBlank()) {
            errors.add("Anthropic API Keyæœªé…ç½®")
        }
        
        // æ£€æŸ¥Neo4jé…ç½®
        if (settings.neo4jConfig.enabled) {
            if (settings.neo4jConfig.username.isBlank()) {
                errors.add("Neo4jç”¨æˆ·åæœªé…ç½®")
            }
            if (settings.neo4jConfig.password.isBlank()) {
                errors.add("Neo4jå¯†ç æœªé…ç½®")
            }
        }
        
        val messageType = if (errors.isEmpty()) {
            JOptionPane.INFORMATION_MESSAGE
        } else {
            JOptionPane.WARNING_MESSAGE
        }
        
        val message = if (errors.isEmpty()) {
            "é…ç½®éªŒè¯é€šè¿‡ï¼æ‰€æœ‰å¿…éœ€çš„é…ç½®é¡¹éƒ½å·²æ­£ç¡®è®¾ç½®ã€‚"
        } else {
            "å‘ç°ä»¥ä¸‹é…ç½®é—®é¢˜:\\n" + errors.joinToString("\\n- ", "- ")
        }
        
        JOptionPane.showMessageDialog(
            mainPanel,
            message,
            "é…ç½®éªŒè¯ç»“æœ",
            messageType
        )
    }
    
    /**
     * æ‰‹åŠ¨åŒæ­¥çŸ¥è¯†å›¾è°±åˆ°Neo4j
     */
    private fun syncKnowledgeGraphToNeo4j() {
        // æ£€æŸ¥Neo4jæ˜¯å¦é…ç½®å’Œå¯ç”¨
        if (!settings.neo4jConfig.enabled) {
            JOptionPane.showMessageDialog(
                mainPanel,
                "Neo4jæ•°æ®åº“æœªå¯ç”¨ï¼Œè¯·å…ˆåœ¨è®¾ç½®ä¸­é…ç½®Neo4jè¿æ¥ã€‚",
                "åŒæ­¥å¤±è´¥",
                JOptionPane.WARNING_MESSAGE
            )
            return
        }
        
        // æ£€æŸ¥é¡¹ç›®æ˜¯å¦å·²ç´¢å¼•
        val indexingStatus = indexingService.getIndexingStatus()
        if (!indexingStatus.isIndexed) {
            val result = JOptionPane.showConfirmDialog(
                mainPanel,
                "é¡¹ç›®å°šæœªç´¢å¼•æˆ–ç´¢å¼•ä¸å®Œæ•´ã€‚æ˜¯å¦å…ˆè¿›è¡Œé¡¹ç›®ç´¢å¼•ï¼Ÿ",
                "éœ€è¦ç´¢å¼•",
                JOptionPane.YES_NO_OPTION,
                JOptionPane.QUESTION_MESSAGE
            )
            
            if (result == JOptionPane.YES_OPTION) {
                indexingService.startProjectIndexing(false)
                return
            } else {
                return
            }
        }
        
        // æ˜¾ç¤ºç¡®è®¤å¯¹è¯æ¡†
        val confirmed = JOptionPane.showConfirmDialog(
            mainPanel,
            """
            <html>
            <h3>ç¡®è®¤åŒæ­¥çŸ¥è¯†å›¾è°±</h3>
            <p>æ­¤æ“ä½œå°†ï¼š</p>
            <ul>
            <li>æ¸…ç©ºNeo4jæ•°æ®åº“ä¸­çš„ç°æœ‰æ•°æ®</li>
            <li>å°†å½“å‰é¡¹ç›®çš„æ‰€æœ‰ç±»ã€æ–¹æ³•å’Œå…³ç³»åŒæ­¥åˆ°Neo4j</li>
            <li>å¯èƒ½éœ€è¦è¾ƒé•¿æ—¶é—´ï¼Œè¯·è€å¿ƒç­‰å¾…</li>
            </ul>
            <p><b>æ˜¯å¦ç»§ç»­ï¼Ÿ</b></p>
            </html>
            """.trimIndent(),
            "ç¡®è®¤åŒæ­¥",
            JOptionPane.YES_NO_OPTION,
            JOptionPane.QUESTION_MESSAGE
        ) == JOptionPane.YES_OPTION
        
        if (!confirmed) return
        
        // åœ¨åå°æ‰§è¡ŒåŒæ­¥
        Thread {
            SwingUtilities.invokeLater {
                // æ˜¾ç¤ºè¿›åº¦å¯¹è¯æ¡†
                val progressDialog = createSyncProgressDialog()
                progressDialog.isVisible = true
                
                try {
                    // è·å–ä»£ç å›¾è°±æ•°æ®
                    val psiService = com.vyibc.autocr.psi.PSIService.getInstance(project)
                    val codeGraph = psiService.getCodeGraph()
                    
                    // æ‰§è¡ŒåŒæ­¥
                    val result = neo4jService.syncCodeGraphToNeo4j(codeGraph)
                    
                    SwingUtilities.invokeLater {
                        progressDialog.dispose()
                        
                        val messageType = if (result.success) {
                            JOptionPane.INFORMATION_MESSAGE
                        } else {
                            JOptionPane.ERROR_MESSAGE
                        }
                        
                        val message = if (result.success) {
                            """
                            <html>
                            <h3>åŒæ­¥å®Œæˆï¼</h3>
                            <p><b>åŒæ­¥ç»“æœï¼š</b></p>
                            <ul>
                            <li>èŠ‚ç‚¹æ•°é‡: ${result.syncedNodes}</li>
                            <li>å…³ç³»æ•°é‡: ${result.syncedEdges}</li>
                            <li>è€—æ—¶: ${result.duration}ms</li>
                            </ul>
                            <p>æ‚¨ç°åœ¨å¯ä»¥åœ¨Neo4j Browserä¸­æŸ¥çœ‹çŸ¥è¯†å›¾è°±ã€‚</p>
                            </html>
                            """.trimIndent()
                        } else {
                            """
                            <html>
                            <h3>åŒæ­¥å¤±è´¥</h3>
                            <p><b>é”™è¯¯ä¿¡æ¯ï¼š</b>${result.message}</p>
                            <p>è¯·æ£€æŸ¥Neo4jé…ç½®å’Œè¿æ¥çŠ¶æ€ã€‚</p>
                            </html>
                            """.trimIndent()
                        }
                        
                        JOptionPane.showMessageDialog(
                            mainPanel,
                            message,
                            "åŒæ­¥ç»“æœ",
                            messageType
                        )
                        
                        // åˆ·æ–°Neo4jçŠ¶æ€
                        updateNeo4jStatus()
                    }
                    
                } catch (e: Exception) {
                    SwingUtilities.invokeLater {
                        progressDialog.dispose()
                        
                        JOptionPane.showMessageDialog(
                            mainPanel,
                            """
                            <html>
                            <h3>åŒæ­¥è¿‡ç¨‹ä¸­å‘ç”Ÿé”™è¯¯</h3>
                            <p><b>é”™è¯¯è¯¦æƒ…ï¼š</b></p>
                            <p>${e.message}</p>
                            </html>
                            """.trimIndent(),
                            "åŒæ­¥é”™è¯¯",
                            JOptionPane.ERROR_MESSAGE
                        )
                    }
                }
            }
        }.start()
    }
    
    /**
     * åˆ›å»ºåŒæ­¥è¿›åº¦å¯¹è¯æ¡†
     */
    private fun createSyncProgressDialog(): JDialog {
        val dialog = JDialog()
        dialog.title = "æ­£åœ¨åŒæ­¥åˆ°Neo4j..."
        dialog.isModal = true
        dialog.setSize(400, 150)
        dialog.setLocationRelativeTo(mainPanel)
        dialog.defaultCloseOperation = JDialog.DO_NOTHING_ON_CLOSE
        
        val contentPanel = JPanel()
        contentPanel.layout = BoxLayout(contentPanel, BoxLayout.Y_AXIS)
        contentPanel.border = BorderFactory.createEmptyBorder(20, 20, 20, 20)
        
        val messageLabel = JBLabel("<html><h3>æ­£åœ¨åŒæ­¥çŸ¥è¯†å›¾è°±åˆ°Neo4jæ•°æ®åº“...</h3></html>")
        messageLabel.alignmentX = java.awt.Component.CENTER_ALIGNMENT
        
        val progressBar = JProgressBar()
        progressBar.isIndeterminate = true
        progressBar.alignmentX = java.awt.Component.CENTER_ALIGNMENT
        
        val tipLabel = JBLabel("è¯·ç¨å€™ï¼Œè¿™å¯èƒ½éœ€è¦å‡ åˆ†é’Ÿæ—¶é—´...")
        tipLabel.alignmentX = java.awt.Component.CENTER_ALIGNMENT
        
        contentPanel.add(messageLabel)
        contentPanel.add(Box.createVerticalStrut(15))
        contentPanel.add(progressBar)
        contentPanel.add(Box.createVerticalStrut(10))
        contentPanel.add(tipLabel)
        
        dialog.add(contentPanel)
        return dialog
    }
    
    /**
     * æ‰“å¼€è®¾ç½®
     */
    private fun openSettings() {
        com.intellij.openapi.options.ShowSettingsUtil.getInstance()
            .showSettingsDialog(project, "AutoCR")
    }
    
    fun dispose() {
        refreshTimer.stop()
    }
}